Параметры сервисов TotalApi
===========================

Данные параметры должны быть указаны в файле `TotalApi.Server.Host.json`.

Общие параметры приложения
--------------------------
    
    totalapi.log                        - настройки протоколирования (подробности см. внизу этого файла)

    modulesFolders
        Modules (по умолчанию)          - перечень каталогов, разделённых точкой с запятой, откуда следует загружать
                                          сборки программных модулей. Позволяет использовать относительную адресацию,
                                          относительно исполнимого файла приложения. Поддерживается рекурсивная загрузка 
                                          из подкаталогов указанных каталогов. 
                                          Модули из каталога приложения будут загружены в любом случае.
                                          Загружены будут только модули с именем вида TotalApi.*.dll.


Параметры подключения к сервису
-------------------------------
    
    serviceHost
        [protokol:]//[host][:порт]      - адрес и (опционально) порт и протокол подключения к сервису;
                                          если протокол не указан используется `http`; 
                                          если порт не указан - используется порт по умолчанию в зависимости от протокола.
										  
                                           
Для возможности подключения к сервисам по `https`, необходимо зарегистрировать и замапить на указанный порт сертификат. (подробнее как это сделать - читай в [документации](ConfigureHttps\!HowTo.md).

TotalApi.Server.Host
--------------------    
   
    appId
        TotalApi.Server.Host (по умолчанию)  - идентификатор хоста подсистемы. В случае если хост запущен как служба - название службы.
    
    appTitle                                 - наименование хоста подсистемы. В случае если хост запущен как служба - описание службы, иначе - заголовок консольного приложения
параметры командной строки:
    
    /i  - установить в виде службы и запустить
    /a  - установить в автозагрузку и запустить
    /u  - деинсталлировать (остановить и убрать из служб и автозагрузки)
    /s  - молчаливая работа (не видно окна приложения и сообщений)

    ВАЖНО! при изменении протокола или порта сервисов необходима повторная установка (с ключами /i или /a). Перед изменением конфига - выполните деинсталляцию




араметры клиентского приложения (если приложение использует сервисы других подсистем):
--------------------------------------------------------------------------------------
    serverHost
        localhost[:порт] (по умолчанию) - имя и (опционально) порт подключения к сервису биллинга. 
                                          Если порт не указан - используется порт по умолчанию в зависимости от протокола.
    serverProtocol
        http, https (по умолчанию)      - протокол хостинга сервисов биллинга. 

    serverEndpoint
        {Protocol}://{Host}/{ApplicationName}/api/{ApiVersion}/{ApiType}/{ServiceContract} (по умолчанию) 
                                        - шаблон адреса точки подключения к сервису биллинга. Шаблоны  в фигурных скобках будут
                                          заменены соответствующими значениями при построении адреса.
                                          Если макроопределения {ServiceProtocol} и {ServiceContract} отсутствуют
                                          в шаблоне - они будут автоматически добавлены в начало и конец шаблона соответственно.

    apiKey
      <строковое значение>              - значение ApiKey клиента. Если не указано - можно установить программно свойство TotalApiAuth.ApiKey ДО инициализации MefBootstrapper'a.

    appKey
      <строковое значение>              - значение AppKey клиента. Если не указано - можно установить программно свойство TotalApiAuth.AppKey ДО инициализации MefBootstrapper'a.
                                          если установлено одновременно оба значения apiKey и appKey - значение appKey игнорируется.


Параметры телематического модуля:
    
    writeCoordinatesThreads
        8 (по умолчанию)                - количество потоков, обрабатывающих очередь принятых координат. 
                                          Если очередь переполняется - при приёме координат будет выполнятся ожидание до освобождения очереди.

    writeSensorDataThreads                                          
        8 (по умолчанию)                - количество потоков, обрабатывающих очередь принятых данных сенсоров.
                                          Если очередь переполняется - при приёме координат будет выполнятся ожидание до освобождения очереди.
                                                  
    disableCheckingRestrictions
        false  (по умолчанию)           - Только для тестов. Запрещает все виды проверок ограничений при записи данных.
    disableDataFilterManager
        false  (по умолчанию)           - Только для тестов. Запрещает использование конвейров префильтров при записи данных.


    NetworkSettings.HttpPort            - порт сервиса для быстрой записи координат через нативный интерфейс TotalApi по HTTP-протоколу. Работает быстрее чем соответствующий WCF-сервис TotalApi.
        0 (по умолчанию)                  Если равен нулю - не используется. Если не равен - то доступен по адресу http://{host}:{port}/totalapi/fastwriter

    NetworkSettings.TcpPort             - порт сервиса для быстрой записи координат через нативный интерфейс TotalApi по TCP-протоколу. Работает быстрее чем соответствующий WCF-сервис TotalApi.
        0 (по умолчанию)                  Если равен нулю - не используется. Если не равен - то доступен по адресу tcp://{host}:{port}

    NetworkSettings.UdpPort             - порт сервиса для быстрой записи координат через нативный интерфейс TotalApi по UDP-протоколу. Работает быстрее чем соответствующий WCF-сервис TotalApi.
        0 (по умолчанию)                  Если равен нулю - не используется. Если не равен - то доступен по адресу tcp://{host}:{port}

    NetworkSettings.ConcurrencyLevel    - количество потоков, обрабатывающих поступающие запросы по TCP и UDP-протоколам. Для каждого из протоколов создаётся отдельная очередь.
        1 (по умолчанию)                  Если равен нулю - очередь обработки не используется и обработка происходит синхронно с приёмом данных. 

    defaultCoordinateTimeToLive
        1 (по умолчанию)                - время жизни координат устройства слежения по умолчанию (в днях). 
                                          Используется, если свойство Device.TimeToLive меньше или равно TimeSpan.Zero.

    forcedCoordinateTimeToLive
        не задано (по умолчанию)        - принудительное время жизни координат устройства слежения (в днях). 
                                          Если задано - используется вместо свойства Device.TimeToLive.

    defaultSensorsTimeToLive
        1 (по умолчанию)                - время жизни данных датчиков устройства слежения по умолчанию (в днях). 
                                          Используется, если свойство Sensor.TimeToLive меньше или равно TimeSpan.Zero.

    forcedSensorsTimeToLive
        не задано (по умолчанию)        - принудительное время жизни данных датчиков устройства слежения (в днях). 
                                          Если задано - используется вместо свойства Sensor.TimeToLive.


Если приложение одновременно и хостит свои сервисы и использует сервисы других подсистем - App.config может содержать оба набора параметров.

    Пример:
      <appSettings>
        <add key="serviceProtocol" value="https" />
        <add key="serviceHost" value="robosoft.info:8888" />
      </appSettings>

      <appSettings>
        <add key="serverEndpoint" value="https://services.totalapi.io:8888/totalapi/api/v2/wcf/" />
      </appSettings>

      <appSettings>
        <add key="serviceProtocol" value="https" />
        <add key="serviceHost" value="robosoft.info" />
        <add key="serverProtocol" value="https" />
        <add key="serverEndpoint" value="services.totalapi.io:8888/totalapi/api/v2/{ApiType}/" />
      </appSettings>



Параметры для управления протоколированием приложения:
------------------------------------------------------
Данные настройки влияют на вывод информации передаваемой через интерфейс ILogger. По умолчанию приложение сконфигурировано так,
что в качестве обработчика протоколирования уже пожключен класс FileLogger, который управляется этими командами.

Существует два способа управления (они могут использоваться совместно):

Простой способ - использовать следующие команды раздела <appSettings>:

    totalapi.log.async
        true (по умолчанию)             - true - все сообщения логгера попадают в очередь, которая обрабатывается одним отдельным потоком.
                                          false - без очереди (может существенно замедлить работу программы).

    totalapi.log.file
      <строковое значение>              - имя файла протокола. Если полный путь не задан - он расширяется относительно каталога запуска программы.
                                          Если указано имя CON - вывод будет вестись не в файл, а в консоль.
                                          Поддерживаются макроподстановки, используемые в методе FileSystemExtension.ExpandPath.

    totalapi.log.level
      7 (по умолчанию)                  - битовая маска, задающая уровень протоколирования:
                                            1  - информационные сообщения
                                            2  - предупреждения
                                            4  - ошибки
                                            8  - отладка
                                            16 - статистика

    totalapi.log.console
      false (по умолчанию)              - дублировать вывод в файл с выводом в консоль. В DEBUG сборке значение этого параметра по умолчанию равно true.

    totalapi.log.append
      false (по умолчанию)              - создавать файл протокола заново при старте программы или дописывать в существующий.

    totalapi.log.persistent
      false (по умолчанию)              - сохранять файл протокола при старте программы. 
                                          Старый файл переименовывается в <имя файла>.yy-MM-dd.<расширение>. 
                                          Игнорируется если totalapi.log.append равно true.

    totalapi.log.splitDays              
      1 (по умолчанию)                  - Создавать новый файл протокола каждые <splitDays> дня. 
                                          Старый файл переименовывается в <имя файла>.yy-MM-dd.<расширение>. 
                                          Если значение меньше или равно нулю - разбиения файла не происходит.
                                          Если значение не задано, то оно равно 1 если totalapi.log.append или totalapi.log.persistent равно true.

    totalapi.log.splitSizeMb            
      100 (по умолчанию)                - Создавать новый файл протокола когда его размер превышает <splitSizeMb> мегабайт. 
                                          Старый файл переименовывается в <имя файла>.yy-MM-dd.<расширение>. 
                                          Если значение меньше или равно нулю - разбиения файла не происходит.
                                          Если значение не задано, то оно равно 100 если totalapi.log.append или totalapi.log.persistent равно true.

    totalapi.log.separator              
      "\t" (по умолчанию)               - Какими символами разделять разделы в лог-файле. 

Расширенный способ - позволяет задавать несколько файлов протокола:

    Вначале в начало файла app.config требуется добавить описание конфигурационной секции totalapi.log:

      <configSections>
          <section name="totalapi.log" type="TotalApi.Core.Api.FileLoggerConfiguration, TotalApi.Core" />
      </configSections>  


    Затем в разделе files конфигурационной секции totalapi.log можно конфигурировать файлы протокола:

      <totalapi.log>
          <files>
              <add file="con" level="7" />
              <add file="c:\temp\log.txt" console="true" append="true" />
          </files>
      </totalapi.log>


    Если используется json-конфигурационный файл, то достаточно добавить в основной конфигурационный файл секцию вида:

      "totalapi.log" : {
            async: true,
            separator: ";",
            files: [
                { file: "con", level: 7 },
                { file: "log.txt", console: true, append: true }
            ]
      }


ОЧЕНЬ ВАЖНО !!!
~~~~~~~~~~~~~~~
Для Web-приложения НЕЛЬЗЯ указывать файл протокола в каталоге или подкаталоге бинарников приложения. 
В этом случае Web-приложение будет постоянно перестартовывать при попытке записи в протокол.





Дополнительные параметры
------------------------
    
    Billing.WatcherPeriodMin
        1440 (по умолчанию)           - период проверки статусов оплаты. По умолчанию - сутки.

    reconnectBillingPeriodSec
        10 (по умолчанию)             - период в секундах между проверками доступности подсистемы биллинга если она стала недоступной.

    reconnectSubSystemsPeriodSec
        60 (по умолчанию)             - период в секундах между проверками доступности подсистемы если она стала недоступной.

    reconnectSubSystemsMaxAttempts
        3 (по умолчанию)              - максимальное количество попыток подключиться к недоступной подсистеме. 
        
