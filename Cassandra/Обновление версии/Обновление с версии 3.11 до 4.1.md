# **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é Apache Cassandra —Å –≤–µ—Ä—Å–∏–∏ 3.11 –¥–æ 4.1 —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö**  

Apache Cassandra **–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å 3.11 –¥–æ 4.1**, –ø–æ—ç—Ç–æ–º—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ **–ø–æ—ç—Ç–∞–ø–Ω–æ**:  
1. **–°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–∏—Ç—å —Å 3.11 –¥–æ 4.0**  
2. **–ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —Å 4.0 –¥–æ 4.1**  

## **–®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é**  
–ü–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º **–≤–∞–∂–Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä**:

### **1.1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞**  
```bash
nodetool status
```
‚úÖ –£–±–µ–¥–∏—Å—å, —á—Ç–æ **–≤—Å–µ —É–∑–ª—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ `UN` (Up/Normal)**.  

### **1.2. –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø–ª–æ—Ç–Ω–µ–Ω–∏–µ (compaction) –∏ —á–∏—Å—Ç–∫—É (cleanup)**  
–ù–∞ –∫–∞–∂–¥–æ–º —É–∑–ª–µ –≤—ã–ø–æ–ª–Ω–∏:  
```bash
nodetool disableautocompaction
nodetool disablehandoff
```

### **1.3. –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –¥–∞–Ω–Ω—ã—Ö**  
–ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –¥–∞–Ω–Ω—ã—Ö, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –∏ commitlog:  
```bash
sudo systemctl stop cassandra
cp -r /var/lib/cassandra /var/lib/cassandra_backup
cp -r /etc/cassandra /etc/cassandra_backup
```

### **1.4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `Materialized Views`, `SASI Indexes` –∏ `Thrift API`**  
–≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ **—É—Å—Ç–∞—Ä–µ–ª–∏ –∏–ª–∏ —É–¥–∞–ª–µ–Ω—ã –≤ –≤–µ—Ä—Å–∏–∏ 4.x**.  
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–∂–Ω–æ —Ç–∞–∫:  
```bash
SELECT * FROM system_schema.materialized_views;
SELECT * FROM system_schema.indexes WHERE kind='SASI';
```
–ï—Å–ª–∏ —Ç–∞–∫–∏–µ –æ–±—ä–µ–∫—Ç—ã –µ—Å—Ç—å, **–ø–µ—Ä–µ–ø—Ä–æ–µ–∫—Ç–∏—Ä—É–π** –∏—Ö –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º.

---

## **–®–∞–≥ 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å 3.11 –¥–æ 4.0**  
–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–ø–æ–æ—á–µ—Ä—ë–¥–Ω–æ –Ω–∞ –∫–∞–∂–¥–æ–º —É–∑–ª–µ** (Rolling Upgrade).

### **2.1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Cassandra**  
–ù–∞ –∫–∞–∂–¥–æ–º —É–∑–ª–µ –≤—ã–ø–æ–ª–Ω–∏:  
```bash
sudo systemctl stop cassandra
```

### **2.2. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é Cassandra**  
```bash
sudo apt-get remove cassandra
```

### **2.3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Cassandra 4.0**  
–ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞ –Ω–æ–≤—ã–π:  
```bash
echo "deb http://debian.cassandra.apache.org 40x main" | sudo tee /etc/apt/sources.list.d/cassandra.list
sudo apt-get update
sudo apt-get install cassandra
```

### **2.4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é**  
–°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:  
```bash
diff /etc/cassandra/cassandra.yaml /etc/cassandra_backup/cassandra.yaml
```
–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- –£–±–µ–¥–∏—Å—å, —á—Ç–æ `cluster_name`, `listen_address`, `seed_provider` –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å.
- –í–∫–ª—é—á–∏ `enable_virtual_tables: true` (–Ω–æ–≤–∞—è –æ–ø—Ü–∏—è –≤ 4.0).
- –î–æ–±–∞–≤—å `cdc_enabled: false` (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å Change Data Capture).

### **2.5. –ó–∞–ø—É—Å—Ç–∏—Ç—å Cassandra 4.0**  
```bash
sudo systemctl start cassandra
```

### **2.6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**  
```bash
nodetool status
nodetool describecluster
nodetool version
```

### **2.7. –ó–∞–ø—É—Å—Ç–∏—Ç—å `nodetool upgradesstables`**  
–ß—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç SSTables, –≤—ã–ø–æ–ª–Ω–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —É–∑–ª–µ:  
```bash
nodetool upgradesstables
```

‚úÖ **–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö —É–∑–ª–æ–≤ –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é –Ω–∞ 4.1.**

---

## **–®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å 4.0 –¥–æ 4.1**  

–ü—Ä–æ—Ü–µ—Å—Å –∞–Ω–∞–ª–æ–≥–∏—á–µ–Ω:

### **3.1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Cassandra 4.0**
```bash
sudo systemctl stop cassandra
```

### **3.2. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é Cassandra**
```bash
sudo apt-get remove cassandra
```

### **3.3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Cassandra 4.1**
```bash
echo "deb http://debian.cassandra.apache.org 41x main" | sudo tee /etc/apt/sources.list.d/cassandra.list
sudo apt-get update
sudo apt-get install cassandra
```

### **3.4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (`cassandra.yaml`)**
–í Cassandra 4.1 –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä:
```yaml
enable_virtual_tables: true
commitlog_sync: periodic
cdc_enabled: false
```
–£–±–µ–¥–∏—Å—å, —á—Ç–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏.

### **3.5. –ó–∞–ø—É—Å—Ç–∏—Ç—å Cassandra 4.1**
```bash
sudo systemctl start cassandra
```

### **3.6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä**
```bash
nodetool status
nodetool version
nodetool describecluster
```

### **3.7. –§–∏–Ω–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ SSTables**
```bash
nodetool upgradesstables
```

---

## **–®–∞–≥ 4: –ó–∞–≤–µ—Ä—à–∞—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è**
### **4.1. –í–∫–ª—é—á–∏—Ç—å compaction –∏ handoff**
```bash
nodetool enableautocompaction
nodetool enablehandoff
```

### **4.2. –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ**
```bash
nodetool cleanup
nodetool repair
```

### **4.3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏**
```bash
journalctl -u cassandra --no-pager | tail -n 50
grep -i error /var/log/cassandra/system.log
```

---

## **–í—ã–≤–æ–¥**
‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å 3.11 –¥–æ 4.1 –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–æ—ç—Ç–∞–ø–Ω–æ (—á–µ—Ä–µ–∑ 4.0).**  
‚úÖ **SSTables –æ–±–Ω–æ–≤–ª–µ–Ω—ã (`nodetool upgradesstables`).**  
‚úÖ **–ö–ª–∞—Å—Ç–µ—Ä –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ.** üöÄ