[Установка Fail2Ban](https://www.servers.ru/knowledge/linux-administration/how-to-protect-ssh-using-fail2ban-on-ubuntu-16_04)
=============================================================================================================================

Протокол SSH позволяет удаленно управлять устройствами, однако как и любой открытый для публичного доступа сервис, он уязвим для различного рода атак. 
Одна из наиболее очевидных и распространенных уязвимостей — подбор паролей.

В этом руководстве мы рассмотрим защиту SSH от подбора паролей с помощью пакета fail2ban, который ставится на Ubuntu 16.04.

Принцип работы fail2ban прост. Специальный сервис ищет в системных журналах (логах) записи о неудачных попытках аутентификации 
и при определенных условиях с помощью iptables блокирует IP-адреса, с которых ведется атака.

Установка и настройка fail2ban
------------------------------

Все команды, которые приводятся ниже, должны выполняться от имени root-пользователя или с помощью sudo.

Сначала установите пакет fail2ban:

	apt-get install fail2ban

Теперь нужно сделать так, чтобы сервис fail2ban автоматически запускался при загрузке системы:

	systemctl enable fail2ban

Файлы настроек fail2ban расположены в каталоге `/etc/fail2ban/`:

  - `fail2ban.conf` – дефолтные настройки сервиса fail2ban;
  - `fail2ban.d/*.*` – пользовательские настройки сервиса fail2ban;
  - `jail.conf` – дефолтные настройки для защищаемых сервисов;
  - `jail.d/*.*` – пользовательские настройки для защищаемых сервисов;
  - `filter.d/*.*` – настройки шаблонов поиска в системных журналах (логах);
  - `action.d/*.*` – настройки исполняемых действий;
  - `paths*.conf` – настройки путей для различных операционных систем.

Чтобы ваши настройки не перезаписывались при обновлении пакетов, рекомендуем вместо редактирования файлов с дефолтным настройками создавать собственные (пользовательские) файлы настроек.

Вам необходимо удалить дефолтные настройки защиты sshd:

	cat /dev/null >/etc/fail2ban/jail.d/defaults-debian.conf

Затем создайте файл `/etc/fail2ban/jail.d/sshd.conf`. Добавьте в файл следующие записи:

	[sshd]
		enabled = true
		bantime = 600
		findtime = 650
		maxretry = 5

Теперь если параметр `enabled` будет иметь значение `true`, сервис **fail2ban** заблокирует соответствующий IP-адрес на количество секунд, прописанное в параметре `bantime`, при условии, что за период, указанный в секундах в параметре `findtime`, с этого адреса будет проведено заданное параметром `maxretry` или большее число неудачных попыток ssh-аутентификации. По прошествии периода, прописанного в параметре `bantime`, заблокированный IP-адрес автоматически разблокируется.

В нашем примере IP-адрес будет блокироваться на 600 секунд, если в течение последних 650 секунд с него было осуществлено 5 и более неудачных попыток аутентификации.

Настройка сервиса fail2ban завершена, необходимо его перезапустить:

	systemctl restart fail2ban